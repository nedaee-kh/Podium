# راهنمای افزونه ورود یکپارچه - wordpress

افزونه ورود یکپارچه پاد این امکان را به شما می دهد تا بتوانید ورود و احراز هویت پاد را در سایت وردپرسی خود داشته باشید.

برای نصب این افزونه کافی است شما در بخش افزودن افزونه پنل ادمین سایت وردپرسی خود افزونه با عنوان "ورود یکپارچه پاد" را جست و جو نمایید و نسبت به نصب آن اقدام نمایید.  

بعد از نصب و فعال سازی افزونه POD SSO منو POD SSO در منو داشبورد وردپرس قابل دسترس می شود.

با انتخاب منو POD SSO به  تنظیمات افزونه دسترسی پیدا می کنید.

-برای پر کردن فیلد های مورد نظر نیاز است تا شما اطلاعات **شناسه مشتری**، **رمز مشتری** و **توکن کسب و کار** خود را از  پنل مدیریت کسب و کار پاد بیابید و در فیلدهای متناظر در افزونه وارد نمایید.برای این منظور پس از ورود به پنل کسب و کار خود منو احراز هویت یکپارچه را انتخاب نمایید و از منو باز شده کلیدهای اتصال را انتخاب نمایید. در این صفحه شما اطلاعات مورد نیاز که شامل شناسه مشتری، رمز مشتری و توکن کسب و کار را مشاهده می کنید.

شناسه مشتری و رمز مشتری را از پنل کسب و کار خود کپی نموده و در فیلدهای معادل افزونه POD SSO    وارد نمایید.

برای توکن کسب و کار دریافت توکن جدید را انتخاب و توکن دریافت شده را در فیلد متناظر آن در پلاگین وارد نمایید.

پس از وارد نمودن اطلاعات و تکمیل فیلدها کلید ذخیره تغییرات در پلاگین را انتخاب نمایید.

پس از انجام تنظیمات شما می توانید کلید Login with POD را در فرم لاگین وردپرس مشاهده نمایید.

در صورتی که اطلاعات به درستی وارد شده باشد. سیستم یکپارچه پاد قابل استفاده می باشد.
<div class="box-end">
</div>

## راهنمای افزونه پرداخت پیپاد

افزونه پرداخت پیپاد این امکان را به شما می دهد تا به راحتی از امکانات کیف پول و یا پرداخت مستقیم درگاه بانک پاسارگاد استفاده نمایید. این امکان با نصب این افزنه و انجام تنظیماتی که توضیح خواهیم داد قابل دسترسی خواهد بود.

+ در ابتدا لازم به یادآوری است که افزونه پرداخت پاد به تنهایی قابل استفاده نیست قبل از استفاده از افزونه پرداخت پیپاد حتما باید افزونه ورود یکپارچه پاد (POD SSO) را نصب و تنظیمات آن اعمال نمایید. برای نصب و فعال سازی تنظیمات افزونه POD SSO به راهنمای افزونه یکپارچه پاد(POD SSO) مراجعه نمایید.
http://docs.pod.land/vv.1.0.0.0/PODSDKs/wordpressSDKs/3086/sso-plugin

بعد از نصب و فعال سازی افزونه POD SSO شما می توانید با جست جوی نام افزونه پرداخت پیپاد در قسمت افزودن افزونه وردپرس نسبت به نصب آن اقدام نمایید.

بعد از نصب و فعال سازی پلاگین پرداخت امن پاد از منو ووکامرس زیر منو پیکربندی را انتخاب نمایید.

در صفحه پیکربندی سربرگ درگاه پرداخت را انتخاب نمایید. از لیست روش های پرداخت گزینه پرداخت با پیپاد را انتخاب نمایید(دکمه مدیریت).

با ورود به این صفحه تنظیمات پرداخت پیپاد را مشاهده می کنید.

-در این صفحه تنها فیلدی که تنظیم آن اجباری است فیلد صنف کسب و کار شما است. برای اطلاع از کد صنف کسب و کار شما باید به پنل مدیریت کسب و کار پاد خود مراجعه و از زیر منو کسب و کار گزینه اصناف را انتخاب نمایید. در صفحه باز شده شما لیست اصناف کسب و کار خود را مشاهده می کنید. در صفحه  نیاز است تا نام صنف(انگلیسی) مد نظر خود را کپی کرده و در فیلد متناظر با نام صنف کسب و کار شما در افزونه وارد نمایید. 
فیلد های دیگر دارای متن پیش فرض می باشد که می توانید به انتخاب خود تغییر دهید.
بعد از ثبت تغییرات کلید ذخیره تغییرات را انتخاب نمایید.
پلاگین فعال شده و قابل استفاده می باشد.
<div class="box-end">
</div>

## راهنمای کد افزونه ورود یکپارچه پاد

وظیفه افزونه ورود یکپارچه پاد فراهم آوردن امکان استفاده از api های سیستم پاد می باشد.

در ابتدا به ساختار و پوشه بندی افزونه و در ادامه به توضیحات توابع و کلاس ها می پردازیم.

**توضیح ساختار پوشه بندی**

این ساختار پوشه به ما کمک می کند که ساختار مرتب تری و فایل های مرتبط را در کنار هم در یک پوشه مجزا داشته باشیم.

پوشه **admin**: همان طور که از نام آن پیداست کدهای مربوط به تنظیمات افزونه که در قسمت پنل مدیریت قابل مشاهده است را دارا می باشد.

پوشه **pod_sdk**: حاوی کدهای sdk مربوط به برقراری ارتباط با سرویس های پاد

پوشه **public**: شامل کدهایی که کاربر سایت برای ورود و انتقال به پنل پاد نیاز دارد.

**توضیحات کد بخش مدیریت سایت (پوشه admin)**

در این پوشه دو فایل داریم به نام های admin.php و page-form.php.

+ فایل page-form.php حاوی کد html فرم  ورود تنظیمات است.
+ فایل admin.php حاوی کلاسی است که تنظمیات اولیه برای بارگذاری کتابخانه css، افزودن منو به پنل و فرم تنظیمات در آن گنجانده شده است.

**توضیح توابع  admin.php:**
+ تابع init: شامل تنظیمات اولیه و تعریف HOOKs ها وردپرس.
+ تابع wpsso_enqueue_script:  ثبت و بارگذاری فایل css
+   تابع admin_init: ثبت کلید با نام pod_options برای ذخیره تنظمیات افزونه با این نام
+ تابع add_menu_pod: شامل تنظیمات منو و صفحه ای که قرار است در محیط پنل مدیریت سایت وردپرس افزوده و نمایش داده شود.
+ تابع html_page_form:  بارگذاری فایل page-form.php که  فرم HTML تنظیمات در آن قرار دارد.

**توضیحات کد بخش کاربر سایت (پوشه public)**

در این پوشه کدها شامل افزودن کلید ورود به سامانه پاد، ارتباط با سرویس های احراز هویت پاد و ثبت نام و آپدیت کاربر در وردپرس قرار دارد.

**توضیح فایل های موجود در این پوشه**

+ فایل config.php:  این فایل حاوی آدرس سرویس های پاد می باشد.
+ فایل shortcodes.php:  حاوی تعریف کد کوتاه. تعریف shortcode کلید ورود به سامانه پاد
+ فایل functions.php:  بارگذاری فایل css و افزودن کلید ورود به پاد به صفحه لاگین وردپرس
+ فایل init.php:  بارگذاری فایل های pod_sdk و AuthorizeSSO.php و ساخت آبجکت از روی کلاس AuthorizeSSO. و صدا زدن توابع کلاس AuthorizeSSO با توجه به پلسخ دریافتی از سرویس های پاد
+ فایل AuthorizeSSO.php:  شامل توابع ارسال درخواست به سرویس های پاد و ثبت نام و لاگین کاربر در وردپرس

**توضیح کلی روند کار در init.php:**

ابتدا داستان کلی را توضیح می دهیم و در ادامه به معرفی تک تک توابع کلاس AuthorizeSSO می پردازیم.

برای احراز هویت در سامانه پاد ابتدا نیاز است که اطلاعات کسب و کار پاد را که در افزونه ثبت شده را در هنگام انتقال به سایت پاد انتقال دهیم. بعد از انتقال به سایت پاد و احراز هویت مجداد به سایت مبدا با مقدار code تظیم شده در url ارجاع داده می شود. 

پس از این مرحله  سرویس دریافت توکن دسترسی را با code دریافت شده فراخوانی می کنیم. جواب سرویس شامل توکن دسترسی خواهد بود. با استفاده از توکن دریافتی می توانیم سرویس دریافت اطلاعات پروفایل کاربر را فراخوانی کنیم. با فراخوانی این سرویس اطلاعات پروفایل کاربر را به دست می آوریم. 

در این مرحله با استفاده از ایمیل دریافتی (اطلاعات بازگشتی از سرویس دریافت اطلاعات پروفایل پاد) بررسی می کنیم کاربری با ایمیل دریافتی از سرویس پروفایل در وردپرس ثبت نام شده است یا نه. اگر با این ایمیل کاربری ثبت نشده باشد اقدام به ثبت نام کاربر در وردپرس و در صورتی که کاربری با این ایمیل موجود بود اطلاعات کاربر را به روزرسانی می نماییم. در نهایت اقدام به لاگین کردن کاربر در سایت وردپرسی می نماییم.

**توضیح توابع کلاس AuthorizeSSO:**

"__construct": در سازنده این کلاس موارد زیر تنظیم می شود:

+ دریافت تنظیات ثبت شده در قسمت ادمین و انتساب به فیلد podOptions

+ تنظیم url بازگشت از سایت pod

+ تعریف محیط Sandbox یا Production

+ متد setUserIDWP: دریافت id کاربری وردپرس به عنوان ورودی و انتساب id ورودی تابع به userIDWP
+ متد authorize: مقداردهی پارامترهای سرویس authorize پاد و redirect کردن به سامانه پاد
+ متد getAccessTokenWp: تنظیم پارامترهای مورد نیاز از کلاس SSOService (pod_sdk) و فراخوانی متد getAccessToken از کلاس SSOService. جهت دریافت توکن دسترسی.
+ متد getUserProfile: دریافت اطلاعات پروفایل کاربر با استفاده از توکن دسترسی و متد getUserProfile کلاس UserOperationService
+ متد checkEmailExist: بررسی وجود کاربر با ایمیل دریافت شده از سامانه پاد در سیستم وردپرس در صورت وجود کاربر id کاربر وردپرس و در صورت عدم وجود کاربر مقدار false بر می گرداند.
+ متد registerUser: ثبت نام کاربر با اطلاعات پروفایل دریافتی از سرویس پاد
+ متد updateUser: آپدیت اطلاعت کاربر ذخیره شده در دیتابیس وردپرس که شامل نام، نام خانوادگی، نام مستعار و نام نمایشی می باشد.
+ متد updateMetaDataUser: ذخیره pod_user_id و pod_sso_id دریافتی از سرویس پروفایل کاربر به عنوان داده متا کاربر
+ متد userLoggedIn: لاگین کردن کاربر در سایت وردپرس

 <div class="box-end">
</div>

## راهنمای کد افزونه پرداخت پیپاد

افزونه پرداخت پیپاد این امکان را فراهم می کندتا بتوان از امکانات کیف پول و یا پرداخت مستقیم درگاه بانک پاسارگاد استفاده نمود.این افزونه نیازمند پلاگین ووکامرس و افزونه ورود یکپارچه پاد می باشد.

**داستان کلی:**

کاربر با انتخاب پیپاد به عنوان درگاه پرداخت به سایت پرداخت پاد ارجاع داده می شود. در سایت پاد روش پرداخت خود را از بین درگاه بانک پاسارگاد و کیف پول پاد انتخاب می نماید. 

بعد از انجام پرداخت به سایت مرجع بازگشته و وضعیت سفارش با توجه به وضعیت پرداخت آپدیت می شود.  اطلاعات بازگشتی از پرداخت پاد که شامل شماره پیگیری، شماره کارت پرداخت کننده، شماره فاکتور پاد و نوع پرداخت در سایت مبدا ذخیره می شود.

کلاس WC_PodWallet  از کلاس WC_Payment_Gateway که از کلاس های ووکامرس است extends می شود.

**توضیح کلاس WC_PodWallet:**

"__construct": در متد سازنده مقداردهی اولیه صورت می گیرد. مقداردهی config که شامل آدرس سرویس های پاد می باشد.

مشخص کردن نام توابع ارسال به بانک و برگشت از بانک و همچنین فراخوانی متد های init_form_fields و init_settings که متدهای ووکامرس می باشد.

متد send_to_pod_gateway: وظیفه این تابع ارجاع کاربر به صفحه پرداخت پاد می باشد.کارهایی که در داخل این تابع انجام می شود. 

ساخت آبچکت از روی کلاس WC_Order با ورودی شماره سفارش.  از آبجکت ساخته شده با توجه به شماره سفارش ما می توانیم با متودهای کلاس WC_Order مبلغ و واحد پولی را به دست آوریم.

برای استفاده از سرویس های پاد در ابتدا نیاز به ott داریم. برای همین منظور ما سرویس ott را فراخوانی می کنیم با api_token که قبلا در پلاگین POD SSO وارد کرده ایم. در پاسخ دریافتی از سرویس مقدار ott در دسترس می باشد. ott برای استفاده از دیگر سرویس های پرداخت مورد نیاز است.

بعد از دریافت ott سرویس issueInvoice را فراخوانی می کنیم. کار این سرویس صدور فاکتور توسط کسب و کار می باشد. برای فراخوانی این سرویس توضیحات محصول، کد صنف، توضیحات کالا، مبلغ، ott و api_token را ارسال می نماییم. در مرحله بعد از پاسخ دریافتی از سرویس صدور فاکتور استفاده کرده و مقدار uniqueNumber را در صورتی که کاربر با سیستم پاد وارد سیستم نشده باشد و در صورتی که با پاد لاگین کرده باشد مقدار invoiceId را استفاده می نماییم جهت ساخت لینک ارجاع به سایت پرداخت پاد.

بعد از انجام عملیات پرداخت یا انصراف از پرداخت به سایت مبدا ارجاع داده می شویم. در بازگشت از سایت پذیرنده متد return_from_pod_gateway فراخوانی می شود.

متد return_from_pod_gateway:  با بازگشت از سایت پذیرنده این متود فراخوانی می شود. در این متود با توجه به کد سفارش در ابتدا چک می شود که این سفارش وضعیت آن completed و یا processing نباشد چرا که اگر وضعیت در این حالت ها باشد به معنای آن است که پرداخت قبلا انجام شده است. در صورتی که برای شماره سفارش وضعیت های ذکر شده ثبت نشده باشد سرویس verifyAndCloseInvoice  (تایید و بستن فاکتور) را فرا خوانی می کنیم. در صورت موفقیت آمیز بودن پاسخ سرویس اطلاعت پرداخت شامل شماره فاکتور، روش پرداخت و کد رهگیری را در یادداشت های سفارش ثبت می کنیم. و  متد payment_complete ووکامرس را فراخوانی کرده تا ثبت خرید کامل شود. در نهایت با تکمیل خرید متد empty_cart را فراخوانی می نماییم تا سبد خریدی که پرداخت آن انجام شده خالی شود.

<div class="box-end">
</div>