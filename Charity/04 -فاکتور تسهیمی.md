# فاکتور تسهیمی
این نوع فاکتور برای زمانی مناسب است که شما بخواهید به‌عنوان خیریه و به نفع آن، محصولات یا خدمات سایر کسب‌وکارها را به فروش برسانید و سهم‌های جداگانه در نظر بگیرید. در این شرایط می‌توانید نوعی فاکتور با قوانین تسهیم فروش صادر نمایید. ظاهراً خریدار تغییری را احساس نخواهد کرد و یک فاکتور تجمیعی را پرداخت می‌­کند. ولی در عمل، به تعداد ذینفعان با مبلغ تسهیمی، فاکتور صادر شده و مبا‌لغ مستقیماً پس از پرداخت به حساب آن‌­ها منتقل می‌شود.

<div class="box-end">
</div>
## صدور فاکتور تسهیمی
کسب و کار معامله گر که لازم است فاکتور تسهیمی صادر نماید باید از جانب کسب و کارهای سهیم دارای مجوز صدور فاکتور باشد. سپس می‌تواند با استفاده از سرویس زیر تسهیم فروش انجام دهد.

```
var output = new ResultSrv<InvoiceSrv>();
var ottOutput = GetOtt();
var mainInvoiceVos = MainInvoiceVo.ConcreteBuilder
                    .SetGuildCode("{Put your GuildCode}")
                    .SetInvoiceItemVOs(new List<InvoiceItemVo>
                    {
                        InvoiceItemVo.ConcreteBuilder.SetProductId({Put your ProductId}).SetDescription("{Put your 
                        Description}").SetPrice({Put your Price}).SetQuantity({Put your Quantity}).Build()
                    })
                    //.SetBillNumber("{Put your BillNumber}")
                    //.SetDescription("{Put your Description}")
                    //.SetMetadata("{Put your Metadata}")
                    .Build();

var subInvoiceVos = new List<SubInvoiceVo>
                {
                    SubInvoiceVo.ConcreteBuilder
                        .SetBusinessId({Put your BusinessId})
                        .SetGuildCode("{Put your GuildCode}")
                        .SetInvoiceItemVOs(new List<InvoiceItemVo>
                        {
                            InvoiceItemVo.ConcreteBuilder.SetProductId({Put your ProductId}).SetDescription("{Put your 
                            Description}").SetPrice({Put your Price}).SetQuantity({Put your Quantity}).Build()
                        })
                        //.SetBillNumber("{Put your BillNumber}")
                        .SetDescription("{Put your Description}")
                        //.SetMetadata("{Put your Metadata}")
                        .Build()

                };
var customerInvoiceItems = new List<InvoiceItemVo>
                {
                    InvoiceItemVo.ConcreteBuilder.SetProductId({Put your ProductId}).SetDescription("{Put your 
                            Description}").SetPrice({Put your Price}).SetQuantity({Put your Quantity}).Build()
                };
                var multiInvoiceData = MultiInvoiceDataVo.ConcreteBuilder
                    .SetMainInvoice(mainInvoiceVos)
                    .SetSubInvoices(subInvoiceVos)
                    .SetCustomerInvoiceItemVOs(customerInvoiceItems)
                    //.SetPreview({Put your Preview})
                    //.SetCurrencyCode("Put your CurrencyCode")
                    //.SetCustomerDescription("{Put your CustomerDescription}")
                    //.SetCustomerMetadata("{Put your CustomerMetadata}")
                    //.SetPreferredTaxRate({Put your PreferredTaxRate})
                    //.SetRedirectUrl("{Put your RedirectUrl}")
                    //.SetUserId({Put your UserId})
                    //.SetVerificationNeeded({Put your VerificationNeeded})
                    //.SetVoucherHashs({Put your VoucherHashs})
                    .Build();

var issueMultiInvoiceVo = IssueMultiInvoiceVo.ConcreteBuilder
                    .SetOtt(ottOutput.Ott)
                    .SetData(multiInvoiceData)
                    //.SetDelegationHash("{Put your DelegationHash}")
                    //.SetDelegatorId("{Put your DelegatorId}")
                    //.SetForceDelegation("{Put your ForceDelegatio}")
                    .Build();
billingService.IssueMultiInvoice(issueMultiInvoiceVo, response => Listener.GetResult(response, out output));

```



<div class="box-end">
</div>

## کاهش فاکتور تسهیمی
در فاکتور تسهیمی نیز مانند فاکتور عادی با لغو شدن، کل مبلغ فاکتور و با کاهش، قسمتی از مبلغ به مشتری بازگردانده می شود. ولی در فاکتور تسهیمی برای کاهش لازم است کل سهم ها مجدداً اعلام شوند تا مبلغی که کسر می شود از حساب درست برداشته شود. برای کاهش فاکتور تسهیمی از سرویس ReduceMultiInvoice استفاده نمایید.
مقدار id در تمام بخش های اطلاعات ارسالی باید مطابق با شناسه های فاکتور اصلی باشد، در غیر این صورت خطا رخ می دهد. در فاکتور اصلاح شده نیز شرایط زیر لازم است برقرار باشد:      
the share of dealer + the share of shareholder =  the price to be payed by customer
```
 var output = new ResultSrv<InvoiceSrv>();
var mainInvoiceVos = ReduceInvoiceItemVo.ConcreteBuilder
                    .SetId({Put your Id})
                    .SetReduceInvoiceItemVOs(new List<ReduceInvoiceSubItemVo>
                    {
                        ReduceInvoiceSubItemVo.ConcreteBuilder.SetId({Put your Id}).SetDescription("{Put your Description}").SetPrice({Put your Price}).SetQuantity({Put your Quantity}).Build()
                    })
                    .Build();

var subInvoiceVos = new List<ReduceInvoiceItemVo>
                {
                    ReduceInvoiceItemVo.ConcreteBuilder
                        .SetId({Put your Id})
                        .SetReduceInvoiceItemVOs(new List<ReduceInvoiceSubItemVo>
                        {
                            ReduceInvoiceSubItemVo.ConcreteBuilder.SetId({Put your Id}).SetDescription("{Put your 
                            Description}").SetPrice({Put your Price}).SetQuantity({Put your Quantity}).Build()
                        })
                        .Build()
                };
                var customerInvoiceItems = new List<ReduceInvoiceSubItemVo>
                {
                    ReduceInvoiceSubItemVo.ConcreteBuilder.SetId({Put your Id}).SetDescription("{Put your Description}").SetPrice({Put your Price}).SetQuantity({Put your Quantity})
                        .Build()
                };

var reduceMultiInvoiceDataVo = ReduceMultiInvoiceDataVo.ConcreteBuilder
                    .SetMainInvoice(mainInvoiceVos)
                    .SetSubInvoices(subInvoiceVos)
                    .SetCustomerInvoiceItemVOs(customerInvoiceItems)
                    //.SetPreferredTaxRate({Put your PreferredTaxRate})
                    .Build();

var reduceMultiInvoiceVo = ReduceMultiInvoiceVo.ConcreteBuilder
                    .SetData(reduceMultiInvoiceDataVo)
                    .Build();
billingService.ReduceMultiInvoice(reduceMultiInvoiceVo, response => Listener.GetResult(response, out output));

```



<div class="box-end">
</div>

## کاهش فاکتور تسهیمی و انتقال به شبا
در صورتی که می خواهید بلافاصله بعد از کاهش فاکتور، مبلغ برگشتی به شماره شبا کاربر منتقل گردد، از سرویس زیر با همان فرمت data سرویس ReduceMultiInvoice، استفاده نمایید.

```
var output = new ResultSrv<InvoiceSrv>();
var mainInvoiceVos = ReduceInvoiceItemVo.ConcreteBuilder
                    .SetId({Put your Id})
                    .SetReduceInvoiceItemVOs(new List<ReduceInvoiceSubItemVo>
                    {
                        ReduceInvoiceSubItemVo.ConcreteBuilder.SetId({Put your Id}).SetDescription("{Put your 
                        Description}").SetPrice({Put your Price}).SetQuantity({Put your Quantity}).Build()
                    })
                    .Build();

var subInvoiceVos = new List<ReduceInvoiceItemVo>
                {
                    ReduceInvoiceItemVo.ConcreteBuilder
                        .SetId({Put your Id})
                        .SetReduceInvoiceItemVOs(new List<ReduceInvoiceSubItemVo>
                        {
                            ReduceInvoiceSubItemVo.ConcreteBuilder.SetId({Put your Id}).SetDescription("{Put your Description}").SetPrice(50)
                                .SetQuantity({Put your Quantity}).Build()
                        })
                        .Build()
                };
                var customerInvoiceItems = new List<ReduceInvoiceSubItemVo>
                {
                    ReduceInvoiceSubItemVo.ConcreteBuilder.SetId({Put your Id}).SetDescription("{Put your 
                    Description}").SetPrice({Put your Price}).SetQuantity({Put your Quantity}).Build()
                };

var reduceMultiInvoiceDataVo = ReduceMultiInvoiceDataVo.ConcreteBuilder
                    .SetMainInvoice(mainInvoiceVos)
                    .SetSubInvoices(subInvoiceVos)
                    .SetCustomerInvoiceItemVOs(customerInvoiceItems)
                    //.SetPreferredTaxRate({Put your PreferredTaxRate})
                    .Build();

var reduceMultiInvoiceAndCashoutVo = ReduceMultiInvoiceAndCashoutVo.ConcreteBuilder
                    .SetData(reduceMultiInvoiceDataVo)
                    .SetToolCode({Put your ToolCode})
                    .Build();
billingService.ReduceMultiInvoiceAndCashout(reduceMultiInvoiceAndCashoutVo, response => Listener.GetResult(response, out output));

```



<div class="box-end">
</div>
